---
title: "Análisis y Modelos"
subtitle: "Informe de los tiempos de recepción y tiempo limite de respuesta"
output: html_notebook
---
# Introdución 

El presente archivo es un informe de los datos obtenidos al realizar el análisis exploratorio  y modelado del comportamiento  de los tiempos de recepción y tiempo límite de respuesta que fueron capturados en el "Reporte de tiempos respuesta", esto con el objetivo de encontrar información y modelos que sean de ayuda en para la toma de decisiones de la empresa  **ExelPitss**

# Script

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
source("Modelos.R", 
       local = knitr::knit_global(),
       encoding = "utf-8")
```



# Desarrollo 
## Gráficas del análisis exploratorio
```{r echo=FALSE}
tiempos_os_tidy_tbl %>%
  filter(Ruta == "JALISCO",
         Tiempos %in% c("Tiempo efectivo en sitio", "Tiempo de respuesta")) %>%
  ggplot(aes(x = `Técnico de visita`, y = hora_decimal, fill = Tiempos))+
  geom_boxplot() +
  facet_grid(Ruta ~ Tiempos, scales = "free_y") +
  theme(legend.position = "none") +
  ggtitle("Analisis de los tecnicos de visista y sus tiempos de respuesta")+
  coord_flip()

```

```{r,echo=FALSE}
tiempos_os_tidy_tbl %>%
  filter(Tiempos %in% c("Tiempo efectivo en sitio", "Tiempo de respuesta")) %>%
  ggplot(aes(x = Ruta, y = hora_decimal, fill = Tiempos))+
  geom_boxplot() +
  facet_wrap(~ Tiempos, scales = "free_x") +
  theme(legend.position = "none") +
  ggtitle("Analisis de los tiempos de respuesta de las rutas")+
  coord_flip()
```

```{r,echo=FALSE}
plotly::ggplotly(Comp_Jal_NL)
```
Comparaciones del uso de los tiempos por los ingenieros en los estados de Jalisco y Nuevo León

```{r,echo=FALSE}
plotly::ggplotly(TR_ruta)
```
Comparaciones por estado del tiempo que tomó responder una solicitud

```{r,echo=FALSE}
plotly::ggplotly(TE_ruta)
```
Gráficas por estado del tiempo que trabaja el ingeniero en el lugar que se solicitó

```{r,echo=FALSE}
plotly::ggplotly(PerR_ruta)
```
Gráfica que muestra la relación entre el tiempo de respuesta y el límite de tiempo restante, valores más altos del coeficiente significa que se usó más tiempo para solucionar el problema

```{r,echo=FALSE}
plotly::ggplotly(cociente_ruta)
```
Gráficas de los estados en donde se usó más de la mitad del tiempo asignado para atender la solicitud. Pueden observarse casos en donde los valores son muy atípicos, principalmente en casos de hace 2 o 3 años. También hay casos como Puebla en donde una significativa cantidad de veces se usa mucho tiempo para atender una solicitud, puede deberse a que el ingeniero deba desplazarse desde otro estado o a factores externos.

```{r,echo=FALSE}
plotly::ggplotly(ET_ruta)

```
Gráfica que muestra los estados en donde se usó más tiempo del asignado para resolver la solicitud, se puede observar que los excesos de tiempo son anteriores a agosto de 2019

```{r, echo=FALSE}
plotly::ggplotly(TO_ruta)
```
Estados en donde se necesitó la mitad o menos del tiempo asignado para responder una solicitud

## Busqueda de correlaciones 

La siguiente tabla muestra una revisión rápida de cómo se comportan las variables entre si, esto es con el proposito de darnos una idea de qué posibles correlaciones podrían existir y revisar si es producto del azar.

Resultado de las correlaciones entre los tiempos, de las ordenes de servicio que no fueron atendidas en el tiempo asignado 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}

pairs.panels(correlacion_tiempos1_Fals, method = "spearman")
ggcorrplot(correlacion_tiempos2_Fals,method = 'circle', type = 'lower',lab = TRUE)+
  ggtitle("Matriz de correlación")+
  theme_minimal()
corr.test(correlacion_tiempos2_Fals, method = "spearman", adjust = "none")
```
Resultado de las correlaciones entre los tiempos, de las ordenes de servicio que fueron atendidas en el tiempo asignado 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
pairs.panels(correlacion_tiempos1_True, method = "spearman")
ggcorrplot(correlacion_tiempos2_True,method = 'circle', type = 'lower',lab = TRUE)+
  ggtitle("Matriz de correlación")+
  theme_minimal()
corr.test(correlacion_tiempos2_True, method = "spearman", adjust = "none")
```

En las siguientes tablas contienen las siguientes correlaciones   **LRespuesta_TRespuesta_Cor** ( que consta de las variables `Tiempo de respuesta` y `Limite de tiempo de respuesta`) y la columna  **Canvisitas_TRespuesta_Cor** (que consta de las variables`cant_visitas` y `Tiempo de respuesta`). Las correlaciones se hacen de los datos que tienen un coeficiente de tiempo de respuesta y limite de tiempo de respuestas >= 1 y con el modelo de *Spearman*.

Las 3 tablas no muestran correlaciones fiables o que podamos tomar como una correlación válida, en algunos casos esto se debe a la naturaleza de los mismos datos, adicional a esto ver que no existen correlaciones lineales entre las variables utilizadas. 


## Series de tiempo
```{r}
Ten1Jal_tsb%>%
  autoplot(hora_decimal, color='blue') +
  autolayer(components(dcmp_Jal), trend, color='red') +
  xlab("Año") + ylab("Tiempo de respuesta") +
  ggtitle("Tiempo de respuesta Jalisco y su tendencia en rojo")
#Grafica de la tendencia, ajuste estacional y remainder
components(dcmp_Jal) %>% autoplot()+ xlab("Años")
```

```{r}
Ten1Jal_BC_tsb%>%
  autoplot(hora_decimal, color='blue') +
  autolayer(components(dcmp_Jal), trend, color='red') +
  xlab("Año") + ylab("Tiempo de respuesta") +
  ggtitle("Tiempo de respuesta Jalisco y su tendencia en rojo")


#Grafica de la tendencia, ajuste estacional y remainder 
components(dcmp_BC_Jal) %>% autoplot()+ xlab("Años")
lambda1
```

## Modelos 

Grafica del test de los modelos

```{r}
Modelos_fc %>% 
  autoplot(filter_index(Train_tsb, "2018-03-01" ~ "2020-09-01"), level = NULL) +
  ggtitle("Entrenamiento") +
  xlab("Años") + ylab("horas") +
  guides(colour=guide_legend(title="Forecast")) +
  geom_vline(xintercept = as.Date("2020-05-01", color = "Red",
             linetype = "dashed"))+
  # geom_vline( xintercept = as.Date("2020-09-01", color = "Red",
  #                                 linetype = "dashed"))+
  annotate("label", x = c(as.Date("2019-03-01"),as.Date("2020-08-01")),
                        y = 3.5, label = c("Train set", "Test set"),
                        color = c("black","blue"))
```


Analisis estadistico de los modelos  
```{r}
Error_test <- accuracy(Modelos_fc, Train_tsb)
Error_test
```


Analisis de residuos del modelo ARIMA con transformación Box-Cox
```{r}
 Modelos_fit %>%
   select(ARIMA_BC) %>% 
   gg_tsresiduals()+
   ggtitle("Residuales ARIMA_BC")
```



# Conclusiones 


# Bibliografia / Referencias 


* Lenguaje de programacion:
  https://www.r-project.org
  /
* Ambiente de programacion:
  https://rstudio.com/products/rstudio/download/

* Pagina de inicio de estudios
  https://r4ds-en-espaniol.netlify.app

* Principios basicos de las series de tiempo
  https://bookdown.org/content/2274/series-temporales.html
  https://otexts.com/fpp2/

* Ayuda de modelos en R
  https://github.com/tidymodels
  https://www.tidymodels.org/
    
